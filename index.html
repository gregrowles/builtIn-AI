<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gemini (builtIn AI) Interface</title>
  <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.1.0/dist/markdown-it.min.js"></script>
  <script type="module" src="geminiApp.js"></script>
  <link rel="stylesheet" href="style.css" />
</head>

<body>

  <div class="container">

    <!-- Input Panel -->
    <div class="panel input">
      <div style="display: flex;">
        <h2>
          Input Text 
        </h2>
      </div>

      <textarea id="inputText" placeholder="What is today's date?"></textarea>

      <div class="inputsRow">
        <!-- <h2>Model Feature</h2> -->
        <select id="actionSelect">
            <option value="summarize">Summarize</option>
            <option value="summarizeStream">Summarize (Stream)</option>
            <option value="translate">Translate (en-fr)</option>
            <option value="rewrite">Rewrite</option>
            <option value="prompt" selected>Prompt</option>
            <option value="promptStream" selected>Prompt (Stream)</option>
        </select>
        <button id="submit">Submit to AI</button>
        <!-- <div id="stop" class="floatButton">‚èπ</div> -->
      </div>
    </div>

    <!-- Output Panel -->
    <div class="panel output">
      <h2>AI Response</h2>
      <div id="tabList">
        <div id="about" class="floatButton">about</div>
      </div>
      <div id="responseOutput">Awaiting input...</div>
    </div>
  </div>

<script type="text/javascript">

  // note - move to geminiApp.js

  const appPrefix = 'geminiNanoBuiltInApp:';
  const timedResponses = true;
  var lastRequest = null;

    async function submitToAI() {

      const action = document.getElementById('actionSelect').value;
      const inputText = document.getElementById('inputText').value.length ? document.getElementById('inputText').value : document.getElementById('inputText').getAttribute('placeholder');
      const output = document.getElementById('responseOutput');
      output.textContent = 'Thinking...';

      if ( timedResponses ) lastRequest = Date.now();
      // document.getElementById('stop').style.display = 'inline-block';

      setTimeout(() => {
        
        if ( action === 'summarize' ) window.runSummarizer( inputText, submitToAIcompleted );
        if ( action === 'summarizeStream' ) window.runSummarizerStream( inputText, submitToAIcompleted );
        if ( action === 'translate' ) window.runTranslator( inputText, submitToAIcompleted );
        if ( action === 'rewrite' ) window.runRewriter( inputText, submitToAIcompleted );
        if ( action === 'prompt' ) window.runPrompt( inputText, submitToAIcompleted );
        if ( action === 'promptStream' ) window.runPromptStream( inputText, submitToAIcompleted );

      }, 1000);
    }

    async function about() {

      const inputText = document.getElementById('inputText').value;
      const output = document.getElementById('responseOutput');
      output.textContent = 'Checking...';

      setTimeout(() => {
        let result =  `**Gemini Nano** \n\n` +
                     ` The following list of features are available/enabled on your machine: \n` +
                     `| Feature | Enabled | Purpose |\n`+
                     `| --- | --- | --- |\n` +
                    //  `| Summarize | ${( 'Summarizer' in self ? '&#10003;' : ' ' )} | Summarizing narratives, articles or messages |\n` +
                     `| Summarize | ${( 'Summarizer' in self ? '&#10003;' : ' ' )} | Summarizing narratives, articles or messages|\n` +
                     `| Translate (en - fr) | ${( 'Translator' in self ? '&#10003;' : ' ' )} | Translation of texts into other langages (en-fr defaulted) |\n` +
                     `| Rewrite | ${( 'Rewriter' in self ? '&#10003;' : ' ' )} | Rewrite texts to sound more polite or formal |\n` +
                    //  `| Prompt | ${( 'prompt' in self ? '&#10003;' : ' ' )} |\n` +
                     `| Prompt | ${( 'prompt' in self ? '&#10003;' : ' ' )} | Answer questions based on provided texts or general Q&A|\n\n` +
                     `**How to Enable Foundational Model** (e.g. v2Nano) \n\n` + 
                     `1. Copy reserved URL _chrome://flags/#prompt-api-for-gemini-nano_ and paste into new tab \n` + 
                     `2. Enable feature and restart chrome  \n` +
                     `note: visit developer site to [Learn more](https://developer.chrome.com/docs/ai/get-started) \n\n` +
                     `**Getting Started** \n\n` + 
                     `Gemini (Nano) is an experimental AI feature (under Chrome)  \n` + 
                     `**Operating system**: Windows 10 or 11; macOS 13+ (Ventura and onwards); or Linux. Chrome for Android, iOS, and ChromeOS are not yet supported by the APIs which use Gemini Nano.  \n` +
                     `**Storage**: At least 22 GB of free space on the volume that contains your Chrome profile  \n`;

        output.innerHTML = window.markdownReturn( result );
      }, 100);
    }

    async function submitToAIcompleted( result ) {

      console.log( 'submitToAIcompleted', result );

      if ( timedResponses ) result[ 'started' ] = lastRequest;
      if ( timedResponses ) result[ 'completed' ] = Date.now();

      addToTabList( result );

    }

    async function addToTabList( result ) {
        
      console.log( 'addToTabList', result );

      const localID = appPrefix + result.id;

      localStorage.setItem( localID, JSON.stringify( result ) );

      const targ = document.getElementById('tabList');
      const tab = document.createElement('div');

      tab.className = 'floatButton floatTab';
      tab.setAttribute( 'id', localID );
      tab.setAttribute( 'title', result.input );
      tab.innerText = result.input;

      targ.appendChild(tab);

      tab.addEventListener('click', function() {
        readTab( result.id );
        const output = document.getElementById('responseOutput');
        output.innerHTML = window.markdownReturn( "```\n" + result.input + "\n" + "```\n" +  result.response );
        createActionButtonsForTab( result.id );
      });

    }

    async function clipboardCopy( id ) {

      console.log( 'clipboardButton', id );

      const result = await readTab( appPrefix + id );

      if ( !result ) {
        console.error( 'No result found for ID:', id );
        return;
      }

      const textToCopy = `Input: ${result.input}\nResponse: ${result.response}`;

      if ( navigator.clipboard ) {
        try{ 

            navigator.clipboard.writeText(textToCopy)
              .then(() => {
                console.log('Text copied to clipboard');
              })
              .catch(err => {
                console.error('Failed to copy text: ', err);
              });
        } catch (err) {
          console.error('Failed to copy text: ', err);
        }
      } else {
        console.error('Clipboard not available' );
      }

    }

    async function createActionButtonsForTab( id ) {

      console.log( 'createActionButtonsForTab', id );

      const targ = document.getElementById('responseOutput');

      // delete button (remove tab + content + stored entry)
      const clipboardButton = document.createElement('button');

      clipboardButton.className = 'historyButton';
      clipboardButton.innerText = 'Copy';
      clipboardButton.onclick = function() {
        clipboardCopy( id );
      };

      targ.appendChild(clipboardButton);
      
      // delete button (remove tab + content + stored entry)
      const deleteButton = document.createElement('button');

      deleteButton.className = 'historyButton';
      deleteButton.innerText = 'Delete';
      deleteButton.onclick = function() {
        deleteTab( id );
      };

      targ.appendChild(deleteButton);

    }

    async function readAllStoredPrompts() {

      console.log( 'readAllStoredPrompts' );

      const targ = document.getElementById('tabList');

      var arrStoredSearches = [];

      for ( let i = 0; i < localStorage.length; i++ ) {

        const key = localStorage.key(i);
        if ( key.startsWith( appPrefix ) ) {
          const result = JSON.parse( localStorage.getItem( key ) );
          arrStoredSearches.push( result )
        }
      }

      arrStoredSearches.sort( (a,b) => a.completed < b.completed ? -1 : 1 );

      for ( let i = 0; i < arrStoredSearches.length; i++ ) {

        addToTabList( arrStoredSearches[ i ] );

      }
      
    }

    async function readTab( id ) {

      console.log( 'readTab', id );

      return JSON.parse( localStorage.getItem( id ) );

    }

    async function deleteTab( id ) {

      console.log( 'deleteTab', id );

      localStorage.removeItem( appPrefix + id );

      document.getElementById( appPrefix + id ).remove();

      const output = document.getElementById('responseOutput');

      setTimeout(() => {
        let result =  '```\ndone\n```';
        output.innerHTML = window.markdownReturn( result );
      }, 200);

    }


    document.getElementById( 'submit' ).onclick = function() {
        submitToAI();
    };

    document.getElementById( 'about' ).onclick = function() {
        about();
    };

    // document.getElementById( 'stop' ).onclick = function() {
    //     // window.controllerForAbort.abort();
    //     window.stopGemini();
    // };

    readAllStoredPrompts()

    setTimeout(() => {
      about();
    }, 500);

</script>

</body>
</html>
